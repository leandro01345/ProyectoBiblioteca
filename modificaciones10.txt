create or replace
PROCEDURE  PRO_ADD_SOLICITUD (
 id_usuario   SOLICITUD.USUARIO_IDUSUARIO%TYPE
 ) IS
BEGIN
   INSERT INTO SOLICITUD(USUARIO_IDUSUARIO, IDSOLICITUD, FECHASOLICITUD) 	
   VALUES(id_usuario, SEQ_SOLICITUD.NEXTVAL, sysdate);
END;

create or replace
PROCEDURE  PRO_ADD_DETALLESOLICITUD (
 id_ejemplar DETALLESOLICITUD.EJEMPLAR_IDEJEMPLAR%TYPE,
 id_solicitud DETALLESOLICITUD.SOLICITUD_IDSOLICITUD%TYPE
 ) IS
BEGIN
   INSERT INTO DETALLESOLICITUD(EJEMPLAR_IDEJEMPLAR, SOLICITUD_IDSOLICITUD) 	
   VALUES(id_ejemplar, id_solicitud);
END;

create or replace
function fn_ultima_solicitud RETURN NUMBER
IS
idsol NUMBER := -1;
BEGIN
idsol := seq_solicitud.currval;
RETURN idsol;
END fn_ultima_solicitud;

create or replace view v_solicitudes as
select usuario_idusuario as IDUSUARIO, idsolicitud, to_char(FECHASOLICITUD, 'mm/dd/yyyy') as FECHA, to_char(FECHASOLICITUD, 'hh24:mi:ss') as HORA from solicitud;

create or replace
PROCEDURE  PRO_ADD_USUARIO (
 rut_usuario   USUARIO.RUTUSUARIO%TYPE,
 nombres_usuario USUARIO.NOMBRESUSUARIO%TYPE,
 apellidos_usuario USUARIO.APELLIDOSUSUARIO%TYPE,
 direccion_usuario USUARIO.DIRECCIONUSUARIO%TYPE,
 telefono_usuario USUARIO.TELEFONOUSUARIO%TYPE,
 foto_usuario USUARIO.FOTOUSUARIO%TYPE,
 huella_usuario USUARIO.HUELLAUSUARIO%TYPE,
 username_sesion SESION.USERNAMESESION%TYPE,
 password_sesion sesion.passwordsesion%TYPE
 ) IS
BEGIN
   INSERT INTO USUARIO(IDUSUARIO, RUTUSUARIO, NOMBRESUSUARIO, APELLIDOSUSUARIO, DIRECCIONUSUARIO, TELEFONOUSUARIO, ACTIVOUSUARIO, FOTOUSUARIO, HUELLAUSUARIO) 	
   VALUES(SEQ_USUARIO.NEXTVAL, rut_usuario, nombres_usuario, apellidos_usuario, direccion_usuario, telefono_usuario, 'n', foto_usuario, huella_usuario);
   INSERT INTO SESION(IDSESION, USERNAMESESION, PASSWORDSESION, TIPOSESION, USUARIO_IDUSUARIO) 	
   VALUES(SEQ_SESION.NEXTVAL, username_sesion, password_sesion,'usuarioNuevo',SEQ_USUARIO.CURRVAL);
END;

create or replace
PROCEDURE  PRO_ADD_USUARIO (
 rut_usuario   USUARIO.RUTUSUARIO%TYPE,
 nombres_usuario USUARIO.NOMBRESUSUARIO%TYPE,
 apellidos_usuario USUARIO.APELLIDOSUSUARIO%TYPE,
 direccion_usuario USUARIO.DIRECCIONUSUARIO%TYPE,
 telefono_usuario USUARIO.TELEFONOUSUARIO%TYPE,
 foto_usuario USUARIO.FOTOUSUARIO%TYPE,
 huella_usuario USUARIO.HUELLAUSUARIO%TYPE,
 username_sesion SESION.USERNAMESESION%TYPE,
 password_sesion sesion.passwordsesion%TYPE,
 email_usuario USUARIO.EMAILUSUARIO%TYPE
 ) IS
BEGIN
   INSERT INTO USUARIO(IDUSUARIO, RUTUSUARIO, NOMBRESUSUARIO, APELLIDOSUSUARIO, DIRECCIONUSUARIO, TELEFONOUSUARIO, ACTIVOUSUARIO, FOTOUSUARIO, HUELLAUSUARIO, EMAILUSUARIO) 	
   VALUES(SEQ_USUARIO.NEXTVAL, rut_usuario, nombres_usuario, apellidos_usuario, direccion_usuario, telefono_usuario, 'n', foto_usuario, huella_usuario, email_usuario);
   INSERT INTO SESION(IDSESION, USERNAMESESION, PASSWORDSESION, TIPOSESION, USUARIO_IDUSUARIO) 	
   VALUES(SEQ_SESION.NEXTVAL, username_sesion, password_sesion,'usuarioNuevo',SEQ_USUARIO.CURRVAL);
END;

ALTER TABLE SESION ADD CONSTRAINT Sesion_Usuario_FK FOREIGN KEY ( Usuario_idUsuario ) REFERENCES Usuario ( idUsuario ) ;

ALTER TABLE SOLICITUD
ADD ESTADOSOLICITUD VARCHAR2 (50);

update solicitud set estadosolicitud = 'pendiente';

create or replace
PROCEDURE  PRO_ADD_SOLICITUD (
 id_usuario IN SOLICITUD.USUARIO_IDUSUARIO%TYPE
 ) IS
BEGIN
   INSERT INTO SOLICITUD(USUARIO_IDUSUARIO, IDSOLICITUD, FECHASOLICITUD, ESTADOSOLICITUD) 	
   VALUES(id_usuario, SEQ_SOLICITUD.NEXTVAL, sysdate, 'pendiente');
END PRO_ADD_SOLICITUD;

create or replace view v_solicitudes_pendientes as
select sol.IDSOLICITUD, us.IDUSUARIO, us.nombresusuario || ' ' || us.apellidosusuario as NOMBREUSUARIO, TO_CHAR(sol.FECHASOLICITUD, 'mm/dd/yyyy') AS FECHA,
    TO_CHAR(sol.FECHASOLICITUD, 'hh24:mi:ss') AS HORA from SOLICITUD sol JOIN USUARIO us on sol.USUARIO_IDUSUARIO = us.IDUSUARIO where ESTADOSOLICITUD = 'pendiente';

create or replace view v_solicitudes as
select sol.IDSOLICITUD, us.IDUSUARIO, us.nombresusuario || ' ' || us.apellidosusuario as NOMBREUSUARIO, TO_CHAR(sol.FECHASOLICITUD, 'mm/dd/yyyy') AS FECHA,
    TO_CHAR(sol.FECHASOLICITUD, 'hh24:mi:ss') AS HORA from SOLICITUD sol JOIN USUARIO us on sol.USUARIO_IDUSUARIO = us.IDUSUARIO;

commit;